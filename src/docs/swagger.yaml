openapi: 3.0.3
info:
  title: NovaHouse Chatbot API
  description: |
    API dla inteligentnego chatbota NovaHouse - firmy specjalizujƒÖcej siƒô w kompleksowych remontach i wyko≈Ñczeniach wnƒôtrz.

    ## Features
    - ü§ñ AI-powered chatbot z Google Gemini
    - üìä Advanced analytics & reporting
    - üìß Email notifications
    - üìÖ Booksy integration
    - üîó Monday.com CRM sync
    - üîí RODO/GDPR compliance
    - üõ°Ô∏è Rate limiting & security
    - üíæ Caching system

  version: 2.1.0
  contact:
    name: NovaHouse Support
    url: https://novahouse.pl
    email: kontakt@novahouse.pl
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:8080
    description: Development server
  - url: https://novahouse-chatbot-api.appspot.com
    description: Production server (GCP App Engine)

tags:
  - name: chatbot
    description: Chat conversations & AI responses
  - name: knowledge
    description: Knowledge base endpoints
  - name: leads
    description: Lead management & qualification
  - name: booking
    description: Booksy calendar integration
  - name: analytics
    description: Analytics & reporting
  - name: health
    description: Health checks & monitoring
  - name: user
    description: User management & RODO consent

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: Admin API key for protected endpoints

  schemas:
    ChatMessage:
      type: object
      required:
        - message
      properties:
        message:
          type: string
          description: User message text
          example: "Ile kosztuje remont ≈Çazienki?"
        session_id:
          type: string
          description: Optional session ID for conversation continuity
          example: "abc123xyz"
        user_id:
          type: string
          description: Optional user identifier
          example: "user_12345"

    ChatResponse:
      type: object
      properties:
        response:
          type: string
          description: AI-generated response
          example: "Koszt remontu ≈Çazienki zale≈ºy od..."
        session_id:
          type: string
          description: Session ID for tracking conversation
          example: "abc123xyz"
        detected_intent:
          type: string
          description: Detected user intent
          enum: [greeting, pricing, services, portfolio, process, booking, contact, goodbye, unknown]
          example: "pricing"
        qualification_score:
          type: number
          format: float
          description: Lead qualification score (0-100)
          example: 75.5
        suggested_actions:
          type: array
          items:
            type: string
          description: Suggested next actions for user
          example: ["Zobacz portfolio", "Um√≥w rozmowƒô"]

    Lead:
      type: object
      required:
        - name
        - email
        - phone
        - service_type
      properties:
        id:
          type: integer
          description: Lead ID
          example: 42
        name:
          type: string
          description: Lead full name
          example: "Jan Kowalski"
        email:
          type: string
          format: email
          description: Lead email address
          example: "jan.kowalski@example.com"
        phone:
          type: string
          description: Lead phone number
          example: "+48 123 456 789"
        service_type:
          type: string
          description: Requested service type
          enum: [renovation, finishing, design, consultation, other]
          example: "renovation"
        package:
          type: string
          description: Service package (S/M/L)
          enum: [S, M, L]
          example: "M"
        budget:
          type: number
          format: float
          description: Estimated budget in PLN
          example: 50000.0
        timeline:
          type: string
          description: Expected timeline
          example: "3-6 miesiƒôcy"
        status:
          type: string
          description: Lead status
          enum: [new, contacted, qualified, converted, lost]
          example: "new"
        qualification_score:
          type: integer
          description: Qualification score (0-100)
          example: 85
        notes:
          type: string
          description: Additional notes
          example: "Zainteresowany kompleksowym remontem kuchni i ≈Çazienki"
        created_at:
          type: string
          format: date-time
          description: Creation timestamp
          example: "2025-01-15T10:30:00Z"
        rodo_consent:
          type: boolean
          description: RODO consent given
          example: true

    Portfolio:
      type: object
      properties:
        title:
          type: string
          example: "Nowoczesny apartament na Wilanowie"
        category:
          type: string
          example: "Kompleksowe wyko≈Ñczenie"
        area:
          type: string
          example: "120m¬≤"
        duration:
          type: string
          example: "3 miesiƒÖce"
        package:
          type: string
          example: "Premium"
        url:
          type: string
          format: uri
          example: "https://novahouse.pl/realizacje/apartament-wilanow"

    Review:
      type: object
      properties:
        author:
          type: string
          example: "Anna Kowalska"
        rating:
          type: integer
          minimum: 1
          maximum: 5
          example: 5
        text:
          type: string
          example: "Profesjonalna obs≈Çuga, terminowo≈õƒá, super jako≈õƒá!"
        date:
          type: string
          example: "2 miesiƒÖce temu"
        source:
          type: string
          example: "Google"

    AnalyticsStats:
      type: object
      properties:
        total_conversations:
          type: integer
          example: 1547
        total_leads:
          type: integer
          example: 234
        conversion_rate:
          type: number
          format: float
          example: 15.13
        avg_session_duration:
          type: number
          format: float
          description: Average session duration in seconds
          example: 245.5
        popular_intents:
          type: object
          additionalProperties:
            type: integer
          example:
            pricing: 423
            services: 356
            portfolio: 289

    Error:
      type: object
      properties:
        error:
          type: string
          description: Error message
          example: "Invalid input data"
        details:
          type: string
          description: Detailed error information
          example: "Email field is required"

paths:
  /health:
    get:
      tags: [health]
      summary: Health check endpoint
      description: Returns API health status
      responses:
        '200':
          description: API is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "healthy"
                  timestamp:
                    type: string
                    format: date-time
                  version:
                    type: string
                    example: "2.1.0"

  /api/chat:
    post:
      tags: [chatbot]
      summary: Send chat message
      description: Send user message and receive AI-generated response
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatMessage'
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatResponse'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          description: Rate limit exceeded
          headers:
            X-RateLimit-Limit:
              schema:
                type: integer
              description: Request limit per window
            X-RateLimit-Remaining:
              schema:
                type: integer
              description: Remaining requests in current window
            X-RateLimit-Reset:
              schema:
                type: integer
              description: Unix timestamp when limit resets
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/knowledge/portfolio:
    get:
      tags: [knowledge]
      summary: Get portfolio projects
      description: Returns list of completed projects with photos and details
      responses:
        '200':
          description: Portfolio list
          content:
            application/json:
              schema:
                type: object
                properties:
                  portfolio:
                    type: array
                    items:
                      $ref: '#/components/schemas/Portfolio'

  /api/knowledge/process:
    get:
      tags: [knowledge]
      summary: Get process steps
      description: Returns 4-step NovaHouse process description
      responses:
        '200':
          description: Process steps
          content:
            application/json:
              schema:
                type: object
                properties:
                  steps:
                    type: array
                    items:
                      type: object
                      properties:
                        number:
                          type: integer
                        title:
                          type: string
                        description:
                          type: string

  /api/knowledge/reviews:
    get:
      tags: [knowledge]
      summary: Get client reviews
      description: Returns authentic Google reviews from satisfied clients
      responses:
        '200':
          description: Client reviews
          content:
            application/json:
              schema:
                type: object
                properties:
                  reviews:
                    type: array
                    items:
                      $ref: '#/components/schemas/Review'
                  average_rating:
                    type: number
                    format: float
                    example: 5.0

  /api/knowledge/partners:
    get:
      tags: [knowledge]
      summary: Get product partners
      description: Returns list of 17 premium brand partners
      responses:
        '200':
          description: Partner brands list
          content:
            application/json:
              schema:
                type: object
                properties:
                  partners:
                    type: array
                    items:
                      type: string
                    example: ["TubƒÖdzin", "Parady≈º", "Cerrad", "Opoczno"]

  /api/knowledge/stats:
    get:
      tags: [knowledge]
      summary: Get company statistics
      description: Returns key NovaHouse statistics (projects, satisfaction, recommendations)
      responses:
        '200':
          description: Company stats
          content:
            application/json:
              schema:
                type: object
                properties:
                  completed_projects:
                    type: string
                    example: "30+"
                  client_satisfaction:
                    type: string
                    example: "95%"
                  recommendation_rate:
                    type: string
                    example: "94%"
                  years_experience:
                    type: integer
                    example: 5

  /api/knowledge/all:
    get:
      tags: [knowledge]
      summary: Get all knowledge base
      description: Returns complete knowledge base including portfolio, process, reviews, partners, team, stats
      responses:
        '200':
          description: Complete knowledge base
          content:
            application/json:
              schema:
                type: object
                properties:
                  portfolio:
                    type: array
                  process:
                    type: array
                  reviews:
                    type: array
                  partners:
                    type: array
                  team:
                    type: object
                  stats:
                    type: object
                  why_us:
                    type: array

  /api/leads:
    get:
      tags: [leads]
      summary: Get all leads
      description: Returns paginated list of leads with optional filtering
      security:
        - ApiKeyAuth: []
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: per_page
          in: query
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: Leads list
          content:
            application/json:
              schema:
                type: object
                properties:
                  leads:
                    type: array
                    items:
                      $ref: '#/components/schemas/Lead'
                  total:
                    type: integer
                  page:
                    type: integer
                  per_page:
                    type: integer

    post:
      tags: [leads]
      summary: Create new lead
      description: Creates new lead and sends email notifications to admin and customer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Lead'
      responses:
        '201':
          description: Lead created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Lead created successfully"
                  lead_id:
                    type: integer
                    example: 42
                  monday_item_id:
                    type: string
                    example: "12345678"

  /api/leads/filter:
    post:
      tags: [leads]
      summary: Filter leads
      description: Advanced lead filtering by status, date range, package, qualification score
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                status:
                  type: string
                  enum: [new, contacted, qualified, converted, lost]
                start_date:
                  type: string
                  format: date
                end_date:
                  type: string
                  format: date
                package:
                  type: string
                  enum: [S, M, L]
                min_score:
                  type: integer
                  minimum: 0
                  maximum: 100
                page:
                  type: integer
                  default: 1
                per_page:
                  type: integer
                  default: 20
      responses:
        '200':
          description: Filtered leads
          content:
            application/json:
              schema:
                type: object
                properties:
                  leads:
                    type: array
                    items:
                      $ref: '#/components/schemas/Lead'
                  total:
                    type: integer

  /api/leads/export:
    post:
      tags: [leads]
      summary: Export leads to CSV
      description: Export filtered leads to CSV file
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                status:
                  type: string
                start_date:
                  type: string
                  format: date
                end_date:
                  type: string
                  format: date
      responses:
        '200':
          description: CSV file
          content:
            text/csv:
              schema:
                type: string
                format: binary

  /api/leads/bulk-update:
    post:
      tags: [leads]
      summary: Bulk update leads
      description: Update status for multiple leads at once
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - lead_ids
                - status
              properties:
                lead_ids:
                  type: array
                  items:
                    type: integer
                  example: [1, 2, 3, 4, 5]
                status:
                  type: string
                  enum: [new, contacted, qualified, converted, lost]
                  example: "contacted"
      responses:
        '200':
          description: Bulk update successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Updated 5 leads successfully"
                  updated_count:
                    type: integer
                    example: 5

  /api/booking/availability:
    get:
      tags: [booking]
      summary: Get available time slots
      description: Fetches available booking slots from Booksy calendar
      parameters:
        - name: date
          in: query
          required: true
          schema:
            type: string
            format: date
          example: "2025-01-20"
      responses:
        '200':
          description: Available slots
          content:
            application/json:
              schema:
                type: object
                properties:
                  available_slots:
                    type: array
                    items:
                      type: object
                      properties:
                        time:
                          type: string
                          format: time
                          example: "10:00"
                        duration:
                          type: integer
                          example: 60

  /api/booking/book:
    post:
      tags: [booking]
      summary: Create booking
      description: Books appointment in Booksy and sends confirmation email
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
                - email
                - phone
                - date
                - time
              properties:
                name:
                  type: string
                  example: "Jan Kowalski"
                email:
                  type: string
                  format: email
                  example: "jan@example.com"
                phone:
                  type: string
                  example: "+48 123 456 789"
                date:
                  type: string
                  format: date
                  example: "2025-01-20"
                time:
                  type: string
                  format: time
                  example: "10:00"
                service:
                  type: string
                  example: "Konsultacja projektowa"
      responses:
        '201':
          description: Booking created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Booking created successfully"
                  booking_id:
                    type: string
                    example: "booksy_12345"
                  confirmation_sent:
                    type: boolean
                    example: true

  /api/analytics/stats:
    get:
      tags: [analytics]
      summary: Get analytics overview
      description: Returns key analytics metrics and statistics
      security:
        - ApiKeyAuth: []
      parameters:
        - name: start_date
          in: query
          schema:
            type: string
            format: date
        - name: end_date
          in: query
          schema:
            type: string
            format: date
      responses:
        '200':
          description: Analytics stats
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AnalyticsStats'

  /api/analytics/intents:
    get:
      tags: [analytics]
      summary: Get intent distribution
      description: Returns distribution of detected user intents
      security:
        - ApiKeyAuth: []
      responses:
        '200':
          description: Intent distribution
          content:
            application/json:
              schema:
                type: object
                additionalProperties:
                  type: integer
                example:
                  pricing: 423
                  services: 356
                  portfolio: 289

  /api/user/rodo-consent:
    post:
      tags: [user]
      summary: Submit RODO consent
      description: Records user's RODO/GDPR data processing consent
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - user_id
                - consent_given
              properties:
                user_id:
                  type: string
                  example: "user_12345"
                email:
                  type: string
                  format: email
                  example: "user@example.com"
                consent_given:
                  type: boolean
                  example: true
                marketing_consent:
                  type: boolean
                  example: false
      responses:
        '200':
          description: Consent recorded
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Consent recorded successfully"
