name: Load Testing

on:
  schedule:
    # Run load tests daily at 2 AM UTC
    - cron: "0 2 * * *"
  workflow_dispatch: # Allow manual trigger
    inputs:
      target_url:
        description: "Target URL for load testing"
        required: true
        default: "https://glass-core-467907-e9.ey.r.appspot.com"
      users:
        description: "Number of concurrent users"
        required: true
        default: "50"
      duration:
        description: "Test duration (e.g., 5m, 1h)"
        required: true
        default: "5m"

jobs:
  load-test:
    name: Load Testing with Locust
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install locust

      - name: Run load test
        env:
          TARGET_URL: ${{ github.event.inputs.target_url || 'https://glass-core-467907-e9.ey.r.appspot.com' }}
          USERS: ${{ github.event.inputs.users || '50' }}
          DURATION: ${{ github.event.inputs.duration || '5m' }}
        run: |
          echo "üöÄ Starting load test..."
          echo "Target: $TARGET_URL"
          echo "Users: $USERS"
          echo "Duration: $DURATION"

          locust \
            -f locustfile.py \
            --host=$TARGET_URL \
            --users=$USERS \
            --spawn-rate=10 \
            --run-time=$DURATION \
            --headless \
            --html=load-test-report.html \
            --csv=load-test-results

      - name: Check performance thresholds
        run: |
          # Parse CSV results
          if [ -f "load-test-results_stats.csv" ]; then
            echo "üìä Load Test Statistics:"
            cat load-test-results_stats.csv
            
            # Check if any requests failed
            FAILED=$(awk -F',' 'NR>1 {sum+=$7} END {print sum}' load-test-results_stats.csv)
            TOTAL=$(awk -F',' 'NR>1 {sum+=$4} END {print sum}' load-test-results_stats.csv)
            
            if [ "$TOTAL" -gt 0 ]; then
              ERROR_RATE=$(echo "scale=4; $FAILED / $TOTAL" | bc)
              echo "Error rate: $ERROR_RATE"
              
              # Fail if error rate > 1%
              if (( $(echo "$ERROR_RATE > 0.01" | bc -l) )); then
                echo "‚ùå Error rate exceeded threshold (1%)"
                exit 1
              fi
            fi
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: load-test-results
          path: |
            load-test-report.html
            load-test-results_*.csv

      - name: Comment on PR (if applicable)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');

            // Read statistics
            const stats = fs.readFileSync('load-test-results_stats.csv', 'utf8');
            const lines = stats.split('\n');

            let comment = '## üìä Load Test Results\n\n';
            comment += '```\n' + lines.slice(0, 10).join('\n') + '\n```\n\n';
            comment += `[Full Report](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID})`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
